module.exports=[33199,a=>{"use strict";var b=a.i(77782),c=a.i(2669),d=a.i(53565),e=a.i(46235),f=a.i(66832),g=a.i(51696);async function h(a){let b=await (0,c.createClient)(),h=(0,d.createAdminClient)(),{data:{user:i}}=await b.auth.getUser();if(!i)throw Error("Unauthorized");try{let{data:b,error:c}=await h.from("applications").select(`
                *,
                user:profiles(*),
                course:Course(*),
                offer:admission_offers!inner(*)
            `).eq("id",a).single();if(c||!b)throw console.error("App fetch error:",c),Error("Application not found");let d=b.offer[0],{data:j}=await h.from("tuition_payments").select("*").eq("offer_id",d.id).eq("status","COMPLETED").single();if("ENROLLED"===b.status)return{success:!0,message:"Student is already enrolled."};if("PAYMENT_SUBMITTED"!==b.status&&"OFFER_ACCEPTED"!==b.status)throw Error(`Invalid application status for enrollment: ${b.status}`);let{data:k}=await h.from("students").select("student_id").eq("application_id",a).single();if(k)return"ENROLLED"!==b.status&&await h.from("applications").update({status:"ENROLLED"}).eq("id",a),{success:!0,studentId:k.student_id,message:"Student was already enrolled."};let l=`SYK-${new Date().getFullYear()}-${Math.floor(1e3+9e3*Math.random())}`,m=b.user;if(!m)throw Error("Applicant profile not found");let n=m.first_name||"Student",o=m.last_name||"Sykli",p=`${n.toLowerCase()}.${o.toLowerCase()}@syklicollege.fi`.replace(/\s/g,""),q=0;for(;;){let{data:a}=await h.from("students").select("id").eq("institutional_email",p).single();if(!a)break;q++,p=`${n.toLowerCase()}.${o.toLowerCase()}${q}@syklicollege.fi`.replace(/\s/g,"")}let{error:r,data:s}=await h.from("students").insert({user_id:b.user_id,student_id:l,application_id:a,program_id:b.course_id,enrollment_status:"ACTIVE",institutional_email:p,personal_email:m.email,start_date:new Date().toISOString(),expected_graduation_date:new Date(new Date().setFullYear(new Date().getFullYear()+3)).toISOString()}).select().single();if(r)throw console.error("SIS Creation Failed:",r),Error(`Failed to create student record: ${r.message}`);let{error:t}=await h.from("applications").update({status:"ENROLLED"}).eq("id",a);if(t)throw t;await h.from("audit_logs").insert({action:"ENROLLMENT_CONFIRMED",entity_table:"students",entity_id:l,actor_id:i.id,metadata:{previous_status:b.status,trigger:"TUITION_PAYMENT_VERIFIED",payment_ref:j?.transaction_reference,actor_role:i.id===b.user_id?"APPLICANT":"ADMIN"}});try{await (0,f.provisionLmsAccount)(s.id,p)}catch(a){console.error("LMS Provisioning deferred:",a)}try{await (0,g.provisionItMaterials)(s.id)}catch(a){console.error("IT Materials provisioning deferred:",a)}return(0,e.revalidatePath)("/portal/dashboard"),{success:!0,studentId:l}}catch(a){return console.error("Enrollment Error:",a),{success:!1,error:a.message||"Enrollment failed."}}}(0,a.i(8649).ensureServerEntryExports)([h]),(0,b.registerServerReference)(h,"408cdf7281b5d7026053f987c0c9a13f936daa5cf9",null),a.s(["confirmEnrollment",()=>h])},66832,a=>{"use strict";var b=a.i(77782),c=a.i(53565);async function d(a,b){let d=(0,c.createAdminClient)();console.log(`[LMS Simulation] Provisioning account for ${a} (${b})...`);try{await new Promise(a=>setTimeout(a,800));let c=`LX-${Math.random().toString(36).substring(2,10).toUpperCase()}`,{error:e}=await d.from("students").update({lms_access_data:{account_provisioned:!0,provisioned_at:new Date().toISOString(),lms_token:c,sync_status:"SYNCED"}}).eq("id",a);if(e)throw e;return await d.from("audit_logs").insert({action:"LMS_ACCOUNT_PROVISIONED",entity_table:"students",entity_id:a,metadata:{lms_token:c,email:b}}),console.log(`[LMS Simulation] Account provisioned successfully for ${a}`),{success:!0,lmsToken:c}}catch(a){return console.error("[LMS Simulation] Provisioning failed:",a.message),{success:!1,error:a.message}}}async function e(a,b,d){let e=(0,c.createAdminClient)();console.log(`[LMS Simulation] Syncing module ${b} to LMS for student ${a}...`);try{return await new Promise(a=>setTimeout(a,500)),await e.from("audit_logs").insert({action:"LMS_COURSE_SYNC",entity_table:"module_enrollments",entity_id:`${a}:${b}`,metadata:{student_id:a,module_id:b,semester_id:d,status:"GRANTED"}}),console.log(`[LMS Simulation] Sync completed for ${a} -> ${b}`),{success:!0}}catch(a){return console.error("[LMS Simulation] Sync failed:",a.message),{success:!1,error:a.message}}}(0,a.i(8649).ensureServerEntryExports)([d,e]),(0,b.registerServerReference)(d,"6052a37213a0498364a0c50f9dd077fb0b0bab16a9",null),(0,b.registerServerReference)(e,"70b81b98bfbfaaf3a696ecfc2de0bd424ed369fd46",null),a.s(["provisionLmsAccount",()=>d,"syncEnrollmentToLms",()=>e])},51696,a=>{"use strict";var b=a.i(77782),c=a.i(53565),d=a.i(46235);async function e(a){let b=(0,c.createAdminClient)();try{let{data:c}=await b.from("it_assets").select("*").eq("auto_provision",!0);if(!c||0===c.length)return{success:!0,message:"No auto-provision assets configured"};let{data:e}=await b.from("student_it_access").select("asset_id").eq("student_id",a),f=new Set(e?.map(a=>a.asset_id)||[]),g=[];for(let d of c){if(f.has(d.id))continue;let c=h(d.asset_type),e=new Date;e.setFullYear(e.getFullYear()+1);let{data:i,error:j}=await b.from("student_it_access").insert({student_id:a,asset_id:d.id,credentials:c,activated_at:new Date().toISOString(),expires_at:e.toISOString(),status:"ACTIVE"}).select().single();!j&&i&&(g.push(i),await b.from("it_assets").update({current_usage:d.current_usage+1}).eq("id",d.id))}return(0,d.revalidatePath)("/portal/student/it-access"),{success:!0,provisioned:g}}catch(a){return{success:!1,error:a.message}}}async function f(a){let b=(0,c.createAdminClient)();try{let{error:c}=await b.from("student_it_access").update({status:"DEACTIVATED",deactivated_at:new Date().toISOString()}).eq("student_id",a).in("status",["ACTIVE","PENDING"]);if(c)throw c;let{data:e}=await b.from("student_it_access").select("asset_id").eq("student_id",a).eq("status","DEACTIVATED");if(e)for(let a of e)await b.rpc("decrement_asset_usage",{asset_uuid:a.asset_id});return(0,d.revalidatePath)("/portal/student/it-access"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function g(a,b){let e=(0,c.createAdminClient)();try{let{data:c}=await e.from("it_assets").select("*").eq("id",b).single();if(!c)throw Error("Asset not found");let f=h(c.asset_type),g=new Date;g.setFullYear(g.getFullYear()+1);let{data:i,error:j}=await e.from("student_it_access").upsert({student_id:a,asset_id:b,credentials:f,activated_at:new Date().toISOString(),expires_at:g.toISOString(),status:"ACTIVE"}).select().single();if(j)throw j;return(0,d.revalidatePath)("/admin/it-assets"),{success:!0,access:i}}catch(a){return{success:!1,error:a.message}}}function h(a){switch(a){case"EMAIL":return{email:`student${Math.floor(1e4*Math.random())}@sykli.edu`,password:"SET_ON_FIRST_LOGIN"};case"LMS":return{username:`student${Math.floor(1e4*Math.random())}`,access_token:`lms_${i()}`};case"VPN":return{vpn_key:i(),config_url:"https://vpn.sykli.edu/config"};case"LIBRARY":return{library_id:`LIB${Math.floor(1e5*Math.random())}`,pin:Math.floor(1e3+9e3*Math.random()).toString()};case"VIRTUAL_LAB":return{lab_username:`vlab_${Math.floor(1e4*Math.random())}`,access_url:"https://labs.sykli.edu"};default:return{license_key:i()}}}function i(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}(0,a.i(8649).ensureServerEntryExports)([e,f,g]),(0,b.registerServerReference)(e,"40193cfe8011168c69e76e6f0d1f2aa74333b0c00c",null),(0,b.registerServerReference)(f,"405546470cf23c6d6901f21ea99df9b1d136370dab",null),(0,b.registerServerReference)(g,"60274f106bb48ebe718ec77cc37efad2e71d3cc209",null),a.s(["deactivateItMaterials",()=>f,"manualProvisionItAsset",()=>g,"provisionItMaterials",()=>e])}];

//# sourceMappingURL=OneDrive_Documents_syklicollege_src_app_portal_295da7ac._.js.map