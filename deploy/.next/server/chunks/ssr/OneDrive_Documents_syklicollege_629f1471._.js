module.exports=[77782,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"registerServerReference",{enumerable:!0,get:function(){return d.registerServerReference}});let d=a.r(46504)},8649,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},53565,a=>{"use strict";var b=a.i(96350);function c(){if(!process.env.SUPABASE_SERVICE_ROLE_KEY)throw Error("Missing Supabase Service Role Key");return(0,b.createClient)("https://mrqzlmkdhzwvbpljikjz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}a.s(["createAdminClient",()=>c])},39071,a=>{"use strict";var b=a.i(77782),c=a.i(2669),d=a.i(53565),e=a.i(46235);async function f(a,b,c){let e=(0,d.createAdminClient)(),f=c.reduce((a,b)=>a+b.amount*(b.quantity||1),0),g=`INV-${new Date().getFullYear()}-${Math.floor(1e3+9e3*Math.random())}`,{data:h,error:i}=await e.from("housing_invoices").insert({student_id:a,application_id:b||null,reference_number:g,total_amount:f,status:"PENDING",due_date:new Date(Date.now()+6048e5).toISOString(),currency:"EUR"}).select().single();if(i)throw Error(`Failed to create invoice: ${i.message}`);let j=c.map(a=>({invoice_id:h.id,description:a.description,item_type:a.type,amount:a.amount,quantity:a.quantity||1})),{error:k}=await e.from("housing_invoice_items").insert(j);if(k)throw Error(`Failed to create invoice items: ${k.message}`);return h}async function g(a,b,f){try{let g=await (0,c.createClient)(),h=(0,d.createAdminClient)(),{data:{user:i}}=await g.auth.getUser();if(!i)return{success:!1,error:"Not authenticated"};let{data:j}=await h.from("housing_invoices").select("*, student:students(id)").eq("id",a).single();if(!j)return{success:!1,error:"Invoice not found"};let k=`PGW-${Date.now()}-${Math.floor(1e3*Math.random())}`,l=`https://paygowire.mock/pay/${k}?amount=${j.total_amount}&currency=${j.currency}`,{error:m}=await h.from("housing_payments").insert({invoice_id:a,student_id:j.student_id,amount:j.total_amount-j.paid_amount,currency:j.currency,status:"PENDING",payment_method:b,billing_country:f,paygowire_transaction_id:k,paygowire_payment_url:l});if(m)return console.error("Payment creation error:",m),{success:!1,error:"Failed to initiate payment transaction"};return(0,e.revalidatePath)("/portal/student/housing"),{success:!0,paymentUrl:l,transactionId:k}}catch(a){return{success:!1,error:a.message}}}async function h(a){let b=(0,d.createAdminClient)();try{let{data:c}=await b.from("housing_payments").select("*, invoice:housing_invoices(*)").eq("paygowire_transaction_id",a).single();if(!c)return{success:!1,error:"Payment transaction not found"};if("COMPLETED"===c.status)return{success:!0};let{error:d}=await b.from("housing_payments").update({status:"COMPLETED",paid_at:new Date().toISOString()}).eq("id",c.id);if(d)throw d;await b.from("housing_audit_logs").insert({action:"PAYMENT_COMPLETED",target_resource:"housing_payments",target_id:c.id,details:{transactionId:a,amount:c.amount}});let{data:f}=await b.from("housing_invoices").select("status, application_id").eq("id",c.invoice_id).single();return f?.status==="PAID"&&f.application_id&&await b.from("housing_applications").update({status:"APPROVED"}).eq("id",f.application_id),(0,e.revalidatePath)("/portal/student/housing"),{success:!0}}catch(a){return console.error("Verify payment error:",a),{success:!1,error:a.message}}}async function i(a,b){let g=(0,d.createAdminClient)(),h=await (0,c.createClient)(),{data:{user:i}}=await h.auth.getUser();if(!i)throw Error("Not authenticated");let{data:j}=await h.from("profiles").select("role").eq("id",i.id).single();if(j?.role!=="ADMIN")throw Error("Unauthorized");let{data:k}=await g.from("housing_assignments").select("*, room:housing_rooms(*)").eq("status","ASSIGNED");if(!k)return{success:!0,count:0};let l=0;for(let c of k){let d=`RENT-${b}-${a.toString().padStart(2,"0")}`,{data:e}=await g.from("housing_invoices").select("id").eq("student_id",c.student_id).ilike("reference_number",`${d}%`).single();!e&&(await f(c.student_id,c.application_id,[{description:`Monthly Rent - ${new Intl.DateTimeFormat("en-US",{month:"long"}).format(new Date(b,a-1))} ${b}`,type:"MONTHLY_RENT",amount:c.room?.monthly_rate||600}]),l++)}return(0,e.revalidatePath)("/admin/housing/finance"),{success:!0,count:l}}async function j(a){let b=(0,d.createAdminClient)(),f=await (0,c.createClient)(),{data:{user:g}}=await f.auth.getUser();if(!g)throw Error("Not authenticated");let{data:h}=await f.from("profiles").select("role").eq("id",g.id).single();if(h?.role!=="ADMIN")throw Error("Unauthorized");let{data:i}=await b.from("housing_payments").select("*").eq("id",a).single();if(!i)throw Error("Payment not found");let{error:j}=await b.from("housing_payments").update({status:"COMPLETED",paid_at:new Date().toISOString(),metadata:{reconciled_by:g.id,reconciled_at:new Date().toISOString()}}).eq("id",a);if(j)throw j;return(0,e.revalidatePath)("/admin/housing/finance"),{success:!0}}async function k(a){let b=await (0,c.createClient)(),{data:d,error:e}=await b.from("students").select("*, user:profiles(*)").or(`first_name.ilike.%${a}%,last_name.ilike.%${a}%,student_id.ilike.%${a}%`,{foreignTable:"profiles"}).limit(10);if(e)throw e;return d}(0,a.i(8649).ensureServerEntryExports)([f,g,h,i,j,k]),(0,b.registerServerReference)(f,"701294a399a30dc2c539a178ef7a090c8a82c06c3e",null),(0,b.registerServerReference)(g,"70d3ea16288004c8f33c8a572423abd63ee5816631",null),(0,b.registerServerReference)(h,"4088876cc1344be9f00791bff538c441de0fb9e4d5",null),(0,b.registerServerReference)(i,"606ac5be30d99642bf968cc4560d413c12924b1b07",null),(0,b.registerServerReference)(j,"408a81e780507581004e0e5454a064703f06f6ddf8",null),(0,b.registerServerReference)(k,"40705f306876d039df0bfb029e22be448dc91162ee",null),a.s(["batchGenerateInvoices",()=>i,"generateHousingInvoice",()=>f,"initiatePayment",()=>g,"reconcilePayment",()=>j,"searchStudents",()=>k,"verifyPayment",()=>h])},39482,a=>{"use strict";var b=a.i(39071);a.s([],85686),a.i(85686),a.s(["40705f306876d039df0bfb029e22be448dc91162ee",()=>b.searchStudents,"408a81e780507581004e0e5454a064703f06f6ddf8",()=>b.reconcilePayment,"606ac5be30d99642bf968cc4560d413c12924b1b07",()=>b.batchGenerateInvoices,"701294a399a30dc2c539a178ef7a090c8a82c06c3e",()=>b.generateHousingInvoice],39482)}];

//# sourceMappingURL=OneDrive_Documents_syklicollege_629f1471._.js.map