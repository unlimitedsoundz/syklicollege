module.exports=[77782,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"registerServerReference",{enumerable:!0,get:function(){return d.registerServerReference}});let d=a.r(46504)},8649,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},53565,a=>{"use strict";var b=a.i(96350);function c(){if(!process.env.SUPABASE_SERVICE_ROLE_KEY)throw Error("Missing Supabase Service Role Key");return(0,b.createClient)("https://mrqzlmkdhzwvbpljikjz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}a.s(["createAdminClient",()=>c])},66832,a=>{"use strict";var b=a.i(77782),c=a.i(53565);async function d(a,b){let d=(0,c.createAdminClient)();console.log(`[LMS Simulation] Provisioning account for ${a} (${b})...`);try{await new Promise(a=>setTimeout(a,800));let c=`LX-${Math.random().toString(36).substring(2,10).toUpperCase()}`,{error:e}=await d.from("students").update({lms_access_data:{account_provisioned:!0,provisioned_at:new Date().toISOString(),lms_token:c,sync_status:"SYNCED"}}).eq("id",a);if(e)throw e;return await d.from("audit_logs").insert({action:"LMS_ACCOUNT_PROVISIONED",entity_table:"students",entity_id:a,metadata:{lms_token:c,email:b}}),console.log(`[LMS Simulation] Account provisioned successfully for ${a}`),{success:!0,lmsToken:c}}catch(a){return console.error("[LMS Simulation] Provisioning failed:",a.message),{success:!1,error:a.message}}}async function e(a,b,d){let e=(0,c.createAdminClient)();console.log(`[LMS Simulation] Syncing module ${b} to LMS for student ${a}...`);try{return await new Promise(a=>setTimeout(a,500)),await e.from("audit_logs").insert({action:"LMS_COURSE_SYNC",entity_table:"module_enrollments",entity_id:`${a}:${b}`,metadata:{student_id:a,module_id:b,semester_id:d,status:"GRANTED"}}),console.log(`[LMS Simulation] Sync completed for ${a} -> ${b}`),{success:!0}}catch(a){return console.error("[LMS Simulation] Sync failed:",a.message),{success:!1,error:a.message}}}(0,a.i(8649).ensureServerEntryExports)([d,e]),(0,b.registerServerReference)(d,"6052a37213a0498364a0c50f9dd077fb0b0bab16a9",null),(0,b.registerServerReference)(e,"70b81b98bfbfaaf3a696ecfc2de0bd424ed369fd46",null),a.s(["provisionLmsAccount",()=>d,"syncEnrollmentToLms",()=>e])},96467,a=>{"use strict";var b=a.i(77782),c=a.i(2669),d=a.i(53565),e=a.i(46235),f=a.i(66832);async function g(a){let b=await (0,c.createClient)(),g=(0,d.createAdminClient)(),{data:{user:h}}=await b.auth.getUser();if(!h)throw Error("Unauthorized");try{let{data:b,error:c}=await g.from("students").select("id, enrollment_status, user_id, program_id").eq("user_id",h.id).single();if(c||!b)throw Error("Student record not found");if("ACTIVE"!==b.enrollment_status)throw Error("Only active students can register for courses.");let{data:d,error:i}=await g.from("Subject").select("*").eq("id",a).single();if(i||!d)throw Error("Subject not found");if(d.courseId!==b.program_id)throw Error("This subject is not part of your enrolled program.");let{data:j,error:k}=await g.from("registration_windows").select("*, semesters(*)").eq("status","OPEN").order("open_at",{ascending:!1}).limit(1).single();if(k||!j)throw Error("Registration window is currently closed.");let{data:l}=await g.from("module_enrollments").select("subject_id").eq("student_id",b.id).eq("semester_id",j.semester_id).eq("status","REGISTERED"),m=0;if(l&&l.length>0){let a=l.map(a=>a.subject_id).filter(Boolean),{data:b}=await g.from("Subject").select("creditUnits").in("id",a);m=(b||[]).reduce((a,b)=>a+(b.creditUnits||0),0)}if(m+d.creditUnits>35)throw Error("Credit limit exceeded. Maximum per semester is 35 ECTS.");let{error:n}=await g.from("module_enrollments").upsert({student_id:b.id,subject_id:a,semester_id:j.semester_id,status:"REGISTERED",updated_at:new Date().toISOString()},{onConflict:"student_id, subject_id, semester_id"});if(n)throw n;await g.from("audit_logs").insert({action:"SUBJECT_REGISTRATION",entity_table:"module_enrollments",entity_id:a,actor_id:h.id,metadata:{subject_code:d.code,semester:j.semesters.name,credits:d.creditUnits}});try{await (0,f.syncEnrollmentToLms)(b.id,a,j.semester_id)}catch(a){console.error("LMS Course Sync failed:",a)}return(0,e.revalidatePath)("/portal/student/courses"),{success:!0,message:`Successfully registered for ${d.code}`}}catch(a){return console.error("Registration Error:",a.message),{success:!1,error:a.message}}}async function h(a){let b=await (0,c.createClient)(),f=(0,d.createAdminClient)(),{data:{user:g}}=await b.auth.getUser();if(!g)throw Error("Unauthorized");try{let{data:b,error:c}=await f.from("module_enrollments").select("*").eq("id",a).single();if(c||!b)throw Error("Enrollment not found");let{data:d,error:h}=await f.from("registration_windows").select("*").eq("semester_id",b.semester_id).eq("status","OPEN").single();if(h||!d)throw Error("Registration window is currently closed for this term.");let i=new Date(d.add_drop_deadline);if(new Date>i)throw Error("The add/drop deadline has passed.");let{error:j}=await f.from("module_enrollments").update({status:"DROPPED",updated_at:new Date().toISOString()}).eq("id",a);if(j)throw j;return await f.from("audit_logs").insert({action:"MODULE_DROPPED",entity_table:"module_enrollments",entity_id:a,actor_id:g.id}),(0,e.revalidatePath)("/portal/student/courses"),{success:!0}}catch(a){return{success:!1,error:a.message}}}(0,a.i(8649).ensureServerEntryExports)([g,h]),(0,b.registerServerReference)(g,"4010c9fe1794896cea2e8a49d1db6a3df05671ecfa",null),(0,b.registerServerReference)(h,"40cd3e226cb5b400c9c595e54f52a911c1ddecbc74",null),a.s([],29437),a.i(29437),a.s(["4010c9fe1794896cea2e8a49d1db6a3df05671ecfa",()=>g,"40cd3e226cb5b400c9c595e54f52a911c1ddecbc74",()=>h],96467)}];

//# sourceMappingURL=OneDrive_Documents_syklicollege_f4cda99e._.js.map